# flowgentic

# General
- This project is not released yet. No backward compatibility is needed — freely remove or change old code, APIs, and formats instead of keeping legacy fallbacks.
- Use Conventional Commits for all git commit messages (e.g. `feat: ...`, `fix(scope): ...`).

## Technologies

- Go 1.25, Connect RPC, Protobuf + Buf, SQLite (modernc) + goose migrations, Tailscale/tsnet.
- UI surfaces in `frontend/` (Electron + React + Vite + shadcn + vitest) 

##  Library Docs
- Always use Context7 MCP when I need library/API documentation, code generation, setup or configuration steps without me having to explicitly ask - prefer up-to-date docs over you own knowledge about a library.

# Frontend (frontend/)
- Use pnpm as a package manager.
- ALWAYS use the skills vercel-react-best-practices AND vercel-composition-patterns when doing work in the frontend related to React or frontend work in general.
- Routes from tanstack router get autogenerated - no need to run a npm script.
- Dont use barrel files (index.ts) to export components in the frontend/.

# Go
- To verify go code changes, always run `make build` in the root dir. 
- Proto files live in `internal/proto/definitions/`, generated code in `internal/proto/gen/`. Run `make proto` to regenerate.

# ACP (Agent Client Protocol)

For communication with the agents, we use ACP.
Read the ACP docs for more details: https://agentclientprotocol.com/get-started/introduction.md

## Feature Pattern

Each feature (e.g. `systeminfo`, `workload`) lives in its own package under `internal/<binary>/` (e.g. `internal/worker/systeminfo`, `internal/controlplane/`) and follows this structure:

- **`feature_service.go`** — Business logic. Dependencies are interfaces defined in this file (inversion of control). The service knows nothing about RPC/proto types.
- **`feature.go`** — `StartDeps` struct + `Start(StartDeps)` entry point. Receives all dependencies from the server (mux, logger, interceptors, service interfaces). All `*Deps` structs are checked by `exhaustruct` (`make lint`) to ensure every field is provided at initialization.
- **`<proto_service>_handler.go`** — Private `<protoService>Handler` type implementing the generated Connect interface, delegates to the service. Named after the proto service (e.g. `system_service_handler.go` with `systemServiceHandler`, `worker_service_handler.go` with `workerServiceHandler`). Never use a generic name like `handler`.
- **`server/server.go`** — Wires everything. Creates concrete implementations, constructs `Deps`, and calls `feature.Start()` for each feature.

Shared concerns like auth interceptors live in `internal/<binary>/interceptors/`.

### gRPC Reflection

When adding a new Connect RPC service, register its `ServiceName` in the static reflector in the corresponding `server/server.go`. Both worker and control plane use `grpcreflect.NewStaticReflector(...)` — add the new `<pkg>connect.<Service>ServiceName` constant there, otherwise the service won't be discoverable via gRPC reflection.

### agent drivers (see internal/worker/driver)

#### Codex
For the codex driver and questions regarding the RPC protocol, fetch this page: https://github.com/openai/codex/tree/main/codex-rs/app-server#protocol

## Testing

- One `_test.go` file per source file (e.g. `claude_code.go` → `claude_code_test.go`). Shared test helpers go in `helpers_test.go`.
- Use `t.Run` subtests to structure test cases within each `Test*` function.
- Use `github.com/stretchr/testify` (`assert` + `require`) for assertions.

## TTS Notifications

Use the `/speak` skill to notify the user audibly when something important happens. The user may step away from the screen, so voice notifications help get their attention.

**When to speak:**
- Long-running tasks complete (builds, installs, tests, deployments)
- Tests pass or fail
- Errors or failures that need attention
- Important findings during exploration
- When you need user input on a decision

Keep messages short and conversational.
